'use client';

import { useState } from 'react';
import { Calendar, Activity, Baby, FileText, Filter, CheckCircle, Clock } from 'lucide-react';
import { PregnancyTracker } from '@/types/health-data';

interface PregnancyCheckupsProps {
  data: PregnancyTracker;
}

type CheckupStatus = 'completed' | 'upcoming' | 'overdue' | 'all';

export function PregnancyCheckups({ data }: PregnancyCheckupsProps) {
  const [statusFilter, setStatusFilter] = useState<CheckupStatus>('all');

  const { checkups } = data;

  // Filter checkups by status
  const filterCheckups = () => {
    const today = new Date();

    return checkups.filter(checkup => {
      const checkupDate = new Date(checkup.date);

      if (statusFilter === 'all') return true;
      if (statusFilter === 'completed') return checkupDate <= today;
      if (statusFilter === 'upcoming') return checkupDate > today;
      if (statusFilter === 'overdue') {
        // Overdue would be if expected date passed but not completed
        return checkupDate <= today && !checkup.completed;
      }
      return true;
    });
  };

  const filteredCheckups = filterCheckups();

  // Sort checkups by date
  const sortedCheckups = [...filteredCheckups].sort((a, b) =>
    new Date(a.date).getTime() - new Date(b.date).getTime()
  );

  // Get checkup status
  const getCheckupStatus = (checkup: any) => {
    const today = new Date();
    const checkupDate = new Date(checkup.date);

    if (checkup.completed) return 'completed';
    if (checkupDate <= today) return 'overdue';
    return 'upcoming';
  };

  // Get status badge
  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'completed':
        return (
          <span className="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">
            <CheckCircle className="w-3 h-3 mr-1" />
            已完成
          </span>
        );
      case 'upcoming':
        return (
          <span className="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
            <Clock className="w-3 h-3 mr-1" />
            即将到来
          </span>
        );
      case 'overdue':
        return (
          <span className="inline-flex items-center px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium">
            <Calendar className="w-3 h-3 mr-1" />
            已过期
          </span>
        );
      default:
        return null;
    }
  };

  // Get week from date
  const getWeekFromLMP = (checkupDate: string) => {
    if (!data.pregnancy_info.last_menstrual_period) return null;

    const lmp = new Date(data.pregnancy_info.last_menstrual_period);
    const checkup = new Date(checkupDate);
    const weeks = Math.floor((checkup.getTime() - lmp.getTime()) / (1000 * 60 * 60 * 24 * 7));

    return weeks;
  };

  // Statistics
  const today = new Date();
  const completedCount = checkups.filter(c => new Date(c.date) <= today || c.completed).length;
  const upcomingCount = checkups.filter(c => new Date(c.date) > today).length;
  const overdueCount = checkups.filter(c => new Date(c.date) <= today && !c.completed).length;

  return (
    <div className="space-y-6">
      {/* Statistics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div className="bg-gradient-to-br from-green-50 to-green-100/30 p-4 rounded-xl border border-green-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-600 mb-1">已完成检查</p>
              <p className="text-2xl font-bold text-gray-900">{completedCount}</p>
            </div>
            <CheckCircle className="w-10 h-10 text-green-600" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-blue-50 to-blue-100/30 p-4 rounded-xl border border-blue-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-600 mb-1">即将到来</p>
              <p className="text-2xl font-bold text-gray-900">{upcomingCount}</p>
            </div>
            <Clock className="w-10 h-10 text-blue-600" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-red-50 to-red-100/30 p-4 rounded-xl border border-red-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs text-gray-600 mb-1">已过期</p>
              <p className="text-2xl font-bold text-gray-900">{overdueCount}</p>
            </div>
            <Calendar className="w-10 h-10 text-red-600" />
          </div>
        </div>
      </div>

      {/* Filter Bar */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-macos-text-primary">
          产检记录
        </h3>
        <div className="flex items-center space-x-2">
          <Filter className="w-4 h-4 text-macos-text-muted" />
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value as CheckupStatus)}
            className="px-3 py-2 bg-macos-bg-secondary border border-macos-border rounded-lg text-sm"
          >
            <option value="all">全部</option>
            <option value="completed">已完成</option>
            <option value="upcoming">即将到来</option>
            <option value="overdue">已过期</option>
          </select>
        </div>
      </div>

      {/* Checkups List */}
      <div className="space-y-4">
        {sortedCheckups.map((checkup, index) => {
          const status = getCheckupStatus(checkup);
          const week = getWeekFromLMP(checkup.date);
          const isCompleted = status === 'completed';
          const isUpcoming = status === 'upcoming';

          return (
            <div
              key={index}
              className={`bg-macos-bg-card p-5 rounded-2xl border transition-all ${
                isCompleted
                  ? 'border-macos-border opacity-75'
                  : isUpcoming
                  ? 'border-macos-accent-purple shadow-md'
                  : 'border-red-200 bg-red-50/30'
              }`}
            >
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <div className="flex items-center space-x-3 mb-3">
                    <div
                      className={`w-12 h-12 rounded-full flex items-center justify-center ${
                        isCompleted
                          ? 'bg-green-100'
                          : isUpcoming
                          ? 'bg-macos-accent-purple/20'
                          : 'bg-red-100'
                      }`}
                    >
                      {checkup.checkup_type === 'routine' ? (
                        <Activity className={`w-6 h-6 ${isCompleted ? 'text-green-600' : isUpcoming ? 'text-macos-accent-purple' : 'text-red-600'}`} />
                      ) : (
                        <Baby className={`w-6 h-6 ${isCompleted ? 'text-green-600' : isUpcoming ? 'text-macos-accent-purple' : 'text-red-600'}`} />
                      )}
                    </div>
                    <div className="flex-1">
                      <h4 className="text-base font-semibold text-macos-text-primary">
                        {checkup.checkup_name}
                      </h4>
                      <div className="flex items-center space-x-2 mt-1">
                        {week && (
                          <span className="text-xs text-macos-text-muted">
                            孕期第 {week} 周
                          </span>
                        )}
                        <span className="text-xs text-macos-text-muted">•</span>
                        <span className="text-xs text-macos-text-muted">
                          {checkup.hospital || '未指定医院'}
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Details */}
                  <div className="ml-15 grid grid-cols-2 gap-3 text-sm">
                    <div className="flex items-center space-x-2 text-macos-text-muted">
                      <Calendar className="w-4 h-4" />
                      <span>{checkup.date}</span>
                    </div>
                    {checkup.doctor && (
                      <div className="flex items-center space-x-2 text-macos-text-muted">
                        <Activity className="w-4 h-4" />
                        <span>{checkup.doctor}</span>
                      </div>
                    )}
                  </div>

                  {/* Results or Notes */}
                  {(checkup.results || checkup.notes) && (
                    <div className="ml-15 mt-3 p-3 bg-macos-bg-secondary rounded-lg">
                      {checkup.results && (
                        <div className="mb-2">
                          <p className="text-xs text-macos-text-muted mb-1">检查结果</p>
                          <p className="text-sm text-macos-text-primary">{checkup.results}</p>
                        </div>
                      )}
                      {checkup.notes && !checkup.results && (
                        <div>
                          <p className="text-xs text-macos-text-muted mb-1">备注</p>
                          <p className="text-sm text-macos-text-primary">{checkup.notes}</p>
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Status Badge */}
                <div className="ml-4">{getStatusBadge(status)}</div>
              </div>

              {/* Action Button for Upcoming */}
              {isUpcoming && (
                <div className="mt-4 pt-4 border-t border-macos-border">
                  <button className="w-full px-4 py-2 bg-macos-accent-purple/10 text-macos-accent-purple rounded-lg text-sm font-medium hover:bg-macos-accent-purple/20 transition-colors">
                    查看详情
                  </button>
                </div>
              )}
            </div>
          );
        })}

        {sortedCheckups.length === 0 && (
          <div className="bg-macos-bg-card p-12 rounded-2xl border border-macos-border text-center">
            <Calendar className="w-16 h-16 text-macos-text-muted mx-auto mb-4" />
            <p className="text-macos-text-muted">暂无产检记录</p>
            <p className="text-sm text-macos-text-muted mt-2">
              开始记录您的产检安排和结果
            </p>
          </div>
        )}
      </div>

      {/* Recommended Checkup Schedule */}
      {checkups.length === 0 && (
        <div className="bg-blue-50 p-6 rounded-2xl border border-blue-200">
          <h4 className="text-md font-semibold text-gray-900 mb-3">
            推荐产检时间表
          </h4>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span className="text-gray-700">6-13周</span>
              <span className="text-gray-600">首次产检、NT检查</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-gray-700">14-19周</span>
              <span className="text-gray-600">唐氏筛查</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-gray-700">20-24周</span>
              <span className="text-gray-600">大排畸超声</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-gray-700">24-28周</span>
              <span className="text-gray-600">糖耐量测试</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-gray-700">28-36周</span>
              <span className="text-gray-600">每2周一次检查</span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-gray-700">36-40周</span>
              <span className="text-gray-600">每周一次检查</span>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
